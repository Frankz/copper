cache: cargo
dist: trusty
language: rust
rust: nightly
services: docker
sudo: required

env:
  global:
    - secure: kJof1o+nrjiqS+w8TDDTxhApprxcjksSeovpumuc9eCMGK+4mqtjdl7AGP9AYbIYWAJEF80FJTvXyzviZs7Ov+K52YuLXVkfGSM4v1Gm9NZol6H208QLmggBhsbNzyu3v+/RUTVE3foDAANxhOVXSlLRc8thd9TfzFMRHhna63uNDNLbzE7A1a/etPGLe6QSIGXlQ/EKNUGxA2vTr15xlzm5qmLILHIEGuLEw8IMk0dd8eDYF+vQuQXFnWYL3Wx1MCqk88OK9KpMNR4Rujuewsgb3ODM56y67mRnMyu1wXoN4idXaeGy2S/M3XCdwY0vt/7WTkluTGQ3PQu8tsM5unV50/1x78xw7uEsMFd7g5IJXrsZB00vrrgXjJ/6oOZcNWhWX+LdPa+keyBau6KedPhVt9yFqhgeDIh8+qIDfVGzMmvCN8rcmWQc5z8f370kD7B9/oNp8FPazpU83gtCuWdKLKtxigVCNZWLxiMnH/y4fmNJUqOY0wbyDucNO+io72MNQTLIw5eMNWV7FDgU2pbexckUq763ZmhBhMYwo8e1583mi8jJy8j/hHYWFA4hsnA/5McdBUqxuWZLg2RgB9mJ8EYAJkGE4g2TR+W9GX6pj/xfQ7jLUe8HBgqUKBtDAMz/ZtpU1kpb4IQb1b6uoZci/zWBwCGRGtzJtzak064=
    - CRATE_NAME=trust
    - DEPLOY_VERSION=nightly
    - TARGET=x86_64-unknown-linux-gnu

matrix:
  include:
    # OSX
    - env: TARGET=x86_64-apple-darwin
      os: osx

install:
  - curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain $TRAVIS_RUST_VERSION

  - source ~/.cargo/env

  - rustup component add rust-src

script:
  - cargo generate-lockfile

  - if [ $TRAVIS_OS_NAME = linux ]; then
      sh ci/run-docker.sh $TARGET || exit 1;
    else
      sh ci/run.sh || exit 1;
    fi

  # Travis can't cache files that are not readable by "others"
  - chmod -R a+r $HOME/.cargo

after_success:
  # - if [ $TRAVIS_OS_NAME = linux ] && [ $TRAVIS_PULL_REQUEST = false ]; then
  - if [ $TRAVIS_OS_NAME = linux ]; then
      mkdir ghp-import;

      curl -Ls https://github.com/davisp/ghp-import/archive/master.tar.gz |
        tar --strip-components 1 -C ghp-import -xz;

      ./ghp-import/ghp_import.py book;

      git push -fq https://$GH_TOKEN@github.com/$TRAVIS_REPO_SLUG.git gh-pages && echo OK;
    fi

branches:
  only:
    - auto
    - try

notifications:
  email:
    on_success: never
